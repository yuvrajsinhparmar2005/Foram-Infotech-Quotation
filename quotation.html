<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Quotation | Foram Infotech</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root { --primary: #0062ff; --bg: #f8fafc; --border: #e2e8f0; --text: #334155; }
        body { font-family: 'Noto Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .app-container { max-width: 950px; margin: 0 auto; }

        .dashboard-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .form-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 20px; margin-bottom: 30px; }
        .form-header h2 { margin: 0; color: var(--primary); }

        .section-title { font-size: 0.9rem; text-transform: uppercase; font-weight: 700; color: #94a3b8; margin: 25px 0 15px 0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: #475569; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,98,255,0.1); }

        .items-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .items-table th { background: #f1f5f9; text-align: left; padding: 12px; font-size: 0.8rem; font-weight: 700; color: #475569; }
        .items-table td { padding: 8px; border-top: 1px solid var(--border); vertical-align: top; }
        
        .items-table input { width: 100%; padding: 8px; border: 1px solid transparent; background: transparent; font-family: inherit; font-size: 0.95rem; }
        .items-table input:hover, .items-table input:focus { background: white; border: 1px solid var(--primary); border-radius: 4px; outline: none; }

        .warr-group { display: flex; gap: 5px; border: 1px solid transparent; border-radius: 4px; padding: 2px; }
        .warr-group:hover { border-color: var(--primary); background: white; }
        .warr-group input { border: 1px solid #e2e8f0; width: 45px; text-align: center; border-radius: 4px; padding: 4px; background: white; }
        .warr-group select { border: none; background: transparent; font-size: 0.8rem; color: #334155; cursor: pointer; outline: none; flex: 1; }

        .grand-total-box { background: #eff6ff; padding: 20px; border-radius: 8px; text-align: right; margin-top: 20px; border: 1px solid #bfdbfe; }
        .grand-total-amount { font-size: 1.5rem; color: var(--primary); font-weight: 800; }
        
        .gst-wrapper { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: 600; color: #475569; cursor: pointer; }
        .gst-wrapper input { width: 18px; height: 18px; cursor: pointer; }

        .btn-group { display: flex; gap: 15px; margin-top: 30px; }
        .btn { flex: 1; padding: 12px 20px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; gap: 8px; font-size: 1rem; text-decoration: none; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(0, 98, 255, 0.3); }
        .btn-primary:hover { background: #004ecb; }
        .btn-secondary { background: white; border: 1px solid #ccc; color: #334155; }
        .btn-secondary:hover { background: #f1f5f9; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="dashboard-card">
            <div class="form-header">
                <h2>Quotation Details</h2>
                <a href="index.html" class="btn btn-secondary" style="flex: 0 0 auto;">Close</a>
            </div>

            <form onsubmit="event.preventDefault(); saveAndPreview();">
                <input type="hidden" id="edit-id">
                
                <div class="grid-2">
                    <div>
                        <div class="section-title">Client Details</div>
                        <div class="form-group"><label>Client Name</label><input type="text" id="in_client" required></div>
                        <div class="form-group"><label>Address Line 1</label><input type="text" id="in_addr1"></div>
                        <div class="form-group"><label>Address Line 2</label><input type="text" id="in_addr2"></div>
                    </div>
                    <div>
                        <div class="section-title">Info</div>
                        <div class="form-group">
                            <label>Issuing Company</label>
                            <select id="in_company">
                                <option value="Foram Infotech" selected>Foram Infotech</option>
                                <option value="ABC Corp">ABC Corp</option>
                                <option value="XYZ Solutions">XYZ Solutions</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Quotation No</label><input type="text" id="in_no"></div>
                        <div class="grid-2" style="gap:10px;">
                            <div class="form-group"><label>Issue Date</label><input type="date" id="in_date_issue"></div>
                            <div class="form-group"><label>Valid Until</label><input type="date" id="in_date_valid"></div>
                        </div>
                    </div>
                </div>

                <div class="section-title">Items</div>
                <table class="items-table" id="itemsTable">
                    <thead>
                        <tr>
                            <th width="35%">Description</th>
                            <th width="8%">Qty</th>
                            <th width="15%">Unit Price</th>
                            <th width="32%">Warranty / Guarantee</th>
                            <th width="10%">Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div class="grand-total-box">
                    <label class="gst-wrapper">
                        <input type="checkbox" id="gstCheck" onchange="calculateTotals()">
                        Add 18% GST?
                    </label>

                    <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 5px;" id="subtotalRow" hidden>
                        Subtotal: ₹ <span id="displaySubtotal">0.00</span>
                    </div>

                    <span style="font-size:0.9rem; font-weight:600; color:#64748b;">Grand Total:</span>
                    <span class="grand-total-amount">₹ <span id="displayTotal">0.00</span></span>
                    <span id="displayWords" style="display:block; font-size:0.8rem; color:#64748b; font-style:italic;">Zero Only</span>
                </div>

                <div class="btn-group">
                    <a href="index.html" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Save & Preview >></button>
                </div>

            </form>
        </div>
    </div>

    <script>
        let allQuotes = JSON.parse(localStorage.getItem('myQuotations')) || [];
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        const tableBody = document.querySelector('#itemsTable tbody');

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('in_date_issue').valueAsDate = new Date();
            
            if(editId) {
                const q = allQuotes.find(item => item.id == editId);
                if(q) {
                    document.getElementById('edit-id').value = q.id;
                    document.getElementById('in_company').value = q.company || "Foram Infotech";
                    document.getElementById('in_client').value = q.client;
                    document.getElementById('in_addr1').value = q.addr1;
                    document.getElementById('in_addr2').value = q.addr2;
                    document.getElementById('in_no').value = q.quoteNo;
                    document.getElementById('in_date_issue').value = q.issueDate;
                    document.getElementById('in_date_valid').value = q.validDate;
                    document.getElementById('gstCheck').checked = q.gstAdded || false;
                    
                    if(q.items && q.items.length > 0) {
                        q.items.forEach(item => createRow(item));
                    }
                }
            } else {
                document.getElementById('in_no').value = '2526/' + (Math.floor(Math.random() * 1000) + 100);
            }
            
            // Ensure at least one empty row exists
            if (tableBody.children.length === 0) createRow();
            calculateTotals();
        });

        function createRow(data = {}) {
            let duration = "";
            let unit = "Year";
            let type = "Warranty";

            if (data.warr) {
                const parts = data.warr.split(' ');
                duration = parts[0] || "";
                unit = parts[1] || "Year";
                type = parts[2] || "Warranty";
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="i-desc" placeholder="Item Name" value="${data.desc || ''}"></td>
                <td><input type="number" class="i-qty" value="${data.qty || 1}" style="text-align:center;"></td>
                <td><input type="number" class="i-price" placeholder="0.00" value="${data.price || ''}" style="text-align:right;"></td>
                <td>
                    <div class="warr-group">
                        <input type="text" class="i-warr-duration" placeholder="1" value="${duration}">
                        <select class="i-warr-unit">
                            <option value="Year" ${unit === 'Year' ? 'selected' : ''}>Year(s)</option>
                            <option value="Month" ${unit === 'Month' ? 'selected' : ''}>Month(s)</option>
                        </select>
                        <select class="i-warr-type">
                            <option value="Warranty" ${type === 'Warranty' ? 'selected' : ''}>Warranty</option>
                            <option value="Guarantee" ${type === 'Guarantee' ? 'selected' : ''}>Guarantee</option>
                        </select>
                    </div>
                </td>
                <td style="text-align:right; padding-right:12px; font-weight:bold; padding-top: 12px;" class="i-total">0.00</td>
            `;
            tableBody.appendChild(tr);
            calculateTotals();
        }

        function calculateTotals() {
            let subtotal = 0;
            document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
                const q = parseFloat(row.querySelector('.i-qty').value) || 0;
                const p = parseFloat(row.querySelector('.i-price').value) || 0;
                const t = q * p;
                row.querySelector('.i-total').textContent = t.toFixed(2);
                subtotal += t;
            });

            const isGst = document.getElementById('gstCheck').checked;
            let grandTotal = subtotal;

            if (isGst) {
                const gstAmount = subtotal * 0.18;
                grandTotal = subtotal + gstAmount;
                document.getElementById('subtotalRow').hidden = false;
                document.getElementById('displaySubtotal').textContent = subtotal.toLocaleString('en-IN', {minimumFractionDigits: 2});
            } else {
                document.getElementById('subtotalRow').hidden = true;
            }

            document.getElementById('displayTotal').textContent = grandTotal.toLocaleString('en-IN', {minimumFractionDigits: 2});
            document.getElementById('displayWords').textContent = numberToWords(Math.round(grandTotal));
        }

        tableBody.addEventListener('input', (e) => {
            if(e.target.classList.contains('i-desc')) {
                const row = e.target.closest('tr');
                if(row === tableBody.lastElementChild && e.target.value.trim() !== '') createRow();
            }
            if(e.target.classList.contains('i-qty') || e.target.classList.contains('i-price')) calculateTotals();
        });

        function saveAndPreview() {
            const items = [];
            document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
                const desc = row.querySelector('.i-desc').value;
                if(desc.trim()) {
                    const dur = row.querySelector('.i-warr-duration').value.trim();
                    const unit = row.querySelector('.i-warr-unit').value;
                    const type = row.querySelector('.i-warr-type').value;
                    const warrString = dur ? `${dur} ${unit} ${type}` : '';

                    items.push({
                        desc: desc,
                        qty: row.querySelector('.i-qty').value,
                        price: row.querySelector('.i-price').value,
                        warr: warrString, 
                        total: row.querySelector('.i-total').textContent
                    });
                }
            });

            const formData = {
                id: editId ? parseInt(editId) : Date.now(),
                company: document.getElementById('in_company').value,
                client: document.getElementById('in_client').value,
                addr1: document.getElementById('in_addr1').value,
                addr2: document.getElementById('in_addr2').value,
                quoteNo: document.getElementById('in_no').value,
                issueDate: document.getElementById('in_date_issue').value,
                validDate: document.getElementById('in_date_valid').value,
                grandTotal: document.getElementById('displayTotal').textContent,
                amountWords: document.getElementById('displayWords').textContent,
                gstAdded: document.getElementById('gstCheck').checked,
                items: items
            };

            if(editId) {
                const index = allQuotes.findIndex(q => q.id == editId);
                allQuotes[index] = formData;
            } else {
                allQuotes.push(formData);
            }
            
            localStorage.setItem('myQuotations', JSON.stringify(allQuotes));
            window.location.href = `preview.html?id=${formData.id}`;
        }

        function numberToWords(num) {
            if (num === 0) return "Zero Only";
            const a = ['','One ','Two ','Three ','Four ','Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
            const b = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
            const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return; 
            let str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
            str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
            return str + 'Only';
        }
    </script>
</body>
</html>
